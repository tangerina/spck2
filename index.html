<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
</head>
<body>
<textarea id="taTest" style="width:300px;height:200px;">
@1 t120 v128 o4 L4 ['C8.D-16'2,16]<E+2r
</textarea><br>
  <button id="btnTest">test</button>
</body>
<script>
var target = "";

var PITCH = {">" : +1, "<" : -1};
var KSIG = {"+" : +1, "-" : -1};

function getch(str, pos){
  return (pos < str.length) ? str[pos] : null;
}
function isws(c){ // check if the character is whitespace
  return (!(/\S/).exec(c));
}
function isdigit(c){
  return "1234567890".indexOf(c) >= 0;
}
function readint(str, pos){
  var buf = "";
  while(isdigit(getch(str, pos))){
    buf = buf + getch(str, pos++);
  }
  return {val: Number(buf), pos: pos};
}

var TOKEN_TYPE = {"@":"ToneNo", "t":"Tempo", "o":"Octave", "l":"Length", "r":"Rest", 
                  "c":"Note", "d":"Note", "e":"Note", "f":"Note", "g":"Note", "a":"Note", "b":"Note", 
                  "+":"Sig", "-":"Sig", "\,":"Comma", "[":"SqbrL", "]":"SqbrR", "'":"Chord", 
                  "1":"Number", "2":"Number", "3":"Number", "4":"Number", "5":"Number", 
                  "6":"Number", "7":"Number", "8":"Number", "9":"Number", "0":"Number"};

function gettokentype(c){
  return (c in TOKEN_TYPE) ? TOKEN_TYPE[c] : "Unknown";
}

function tokenize(str, pos){
  var token = {type:null, val:null};
  
  while(isws(getch(str, pos))){ pos++; }
  
  var c = getch(str, pos);
  if (c) {
    var type = gettokentype(c);
    switch(type){
      case "Number":
        token.type = type;
        var result = readint(str, pos);
        token.val = result.val;
        pos = result.pos;
        break;
      case "ToneNo":
      case "Tempo":
      case "Octave":
      case "Length":
      case "Sig":
      case "Comma":
      case "SqbrL":
      case "SqbrR":
      case "Chord":
      case "Note":
      case "Rest":
        token.type = type;
        token.val = c;
        pos++;
        break;
      default:
        token.type = type;
        token.val = c;
        pos++;
        console.log("unknown token [" + c + "]");
    }
  }
    
  return {token:token, pos:pos};
}

function parse(mml) {
  var commands = [];
  /*target = target.toLowerCase();
  
  setpos(0);
  while(getch()){
    var c = getCmd();
    if (!c)ã€€break;
    commands.push(c);
  }*/

  var tokens = [];
  var str = "@3 t135 o4 L16 ['c+f-a'2,32]4r".toLowerCase();
  var pos = 0;
  var cnt = 0; // stopper
  var result = tokenize(str, pos);
  while (result.token.type != null){
    tokens.push(result.token);
    
    result = tokenize(str, result.pos);
    if (++cnt > 50) break;
  }
  tokens.map(t=>{ console.log(t); });
  
  return commands;
};


var MMLTrack2 = function() {
};

MMLTrack2.prototype.parse = function (mml) {
  var commands = [];
  var checked = {};
  var m, cmd, mask;

  commands = parse(mml);
  
  return commands;
};

function test01_read(){
  console.log("test01 start.");

  var m = new MMLTrack2();
  var cmds = m.parse(target);
  cmds.map(c=>{console.log(c);});
  
  console.log("test01 end.");
}
document.getElementById("btnTest").onclick = function(e){
  target = document.getElementById("taTest").value;
  test01_read();
};

</script>
</html>
